name: Run DBpedia Recall Benchmarks

on:
  workflow_call:
    inputs:
      git_sha:
        description: "Git SHA to benchmark"
        required: true
        type: string
    secrets:
      LANCE_BENCH_DB_URI:
        required: true
      BENCH_S3_USER_ACCESS_KEY:
        required: true
      BENCH_S3_USER_SECRET_KEY:
        required: true
      GCP_SERVICE_ACCOUNT_KEY:
        required: true
  workflow_dispatch:
    inputs:
      git_sha:
        description: "Git SHA to benchmark"
        required: true
        type: string

jobs:
  build:
    uses: ./.github/workflows/build-lance-python.yml
    with:
      git_sha: ${{ inputs.git_sha }}

  benchmark:
    needs: build
    runs-on: warp-ubuntu-latest-x64-8x
    steps:
      - name: Checkout lance-bench repository
        uses: actions/checkout@v4

      - name: Checkout lance repository
        uses: actions/checkout@v4
        with:
          repository: lance-format/lance
          ref: ${{ inputs.git_sha }}
          path: lance

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Download DBpedia dataset from GCS
        run: |
          gsutil cp -r gs://lance-benchmarks-ci-datasets/dbpedia.lance .

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Download Lance wheel
        uses: actions/download-artifact@v4
        with:
          name: lance-wheel
          path: wheels/

      - name: Create virtual environment and install dependencies
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install wheels/*.whl numpy

      - name: Run DBpedia benchmarks
        run: |
          source venv/bin/activate
          cd lance
          python benchmarks/dbpedia-openai/benchmarks.py --uri ../dbpedia.lance > ../dbpedia-output.txt

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install lance-bench dependencies
        run: uv sync

      - name: Publish results
        env:
          LANCE_BENCH_URI: ${{ secrets.LANCE_BENCH_DB_URI }}
          AWS_ACCESS_KEY_ID: ${{ secrets.BENCH_S3_USER_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.BENCH_S3_USER_SECRET_KEY }}
        run: |
          uv run python scripts/publish_dbpedia.py \
            dbpedia-output.txt \
            --testbed-name "ubuntu-latest" \
            --dut-name "lance" \
            --dut-version "${{ needs.build.outputs.dut_version }}" \
            --dut-timestamp ${{ needs.build.outputs.timestamp }}
