# This workflow can be dispatched from external repositories.  It is used to
# listen for requests for PR benchmarking from the lance-format/lance repository.

name: PR Comment Monitor

on:
  repository_dispatch:
    types: [pr-comment]

jobs:
  process-comment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout lance-bench repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install PyGithub

      - name: Process PR comment
        id: process
        env:
          GITHUB_TOKEN: ${{ secrets.PR_COMMENT_TOKEN }}
          COMMENT_PAYLOAD: ${{ toJson(github.event.client_payload) }}
        run: |
          python scripts/process_pr_comment.py \
            --payload-json "$COMMENT_PAYLOAD" \
            --output command.json

      - name: Post acknowledgment
        if: steps.process.outputs.should_run == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.PR_COMMENT_TOKEN }}
        run: |
          python scripts/post_pr_comment.py \
            ${{ steps.process.outputs.pr_number }} \
            --repo ${{ steps.process.outputs.pr_repo }} \
            --body "## ðŸš€ Benchmarks Triggered

          Benchmarks requested by @${{ steps.process.outputs.user }}

          **Commit**: \`${{ steps.process.outputs.commit_sha }}\`
          **Configuration**: ${{ steps.process.outputs.config_summary }}

          Results will be posted when complete.

          ---
          *Generated by bench-bot* ðŸ¤–"

      - name: Trigger benchmarks
        if: steps.process.outputs.should_run == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.SCHEDULER_GITHUB_TOKEN }}
          script: |
            const config = JSON.parse(process.env.BENCH_CONFIG);

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'run-benchmarks.yml',
              ref: 'main',
              inputs: {
                git_sha: config.commit_sha,
                pr_number: config.pr_number.toString(),
                pr_repo: config.pr_repo,
                run_rust: config.run_rust.toString(),
                run_python: config.run_python.toString(),
                rust_crates: config.crates.join(',')
              }
            });
        env:
          BENCH_CONFIG: ${{ steps.process.outputs.config }}
